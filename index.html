<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>가계부 및 달력 지출 관리</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Day.js 라이브러리 (날짜/달력 관리를 위해 추가) -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/locale/ko.js"></script>
    <script>dayjs.locale('ko');</script>

    <!-- !!! Firebase 연결 및 Config (모두 통합 완료) !!! -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, deleteDoc, query, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // **********************************************
        // 고객님께서 제공하신 Firebase Config 정보를 통합했습니다.
        // **********************************************
        const firebaseConfig = {
             apiKey: "AIzaSyDibLptsmjCAKK5vziL4VFMN_txxqptmns",
             authDomain: "household-ledger-app.firebaseapp.com",
             projectId: "household-ledger-app",
             storageBucket: "household-ledger-app.firebasestorage.app",
             messagingSenderId: "716953028331",
             appId: "1:716953028331:web:c8c191edfd5235a3d460ae",
             measurementId: "G-9SZG3VCB19"
        }; 

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const ENTRIES_COLLECTION_PATH = `ledger_entries`;

        window.moduleExports = { getFirestore, collection, onSnapshot, doc, deleteDoc, query, addDoc, ENTRIES_COLLECTION_PATH };

        window.firebaseReady = new Promise(async (resolve) => {
            let userId = 'loading';
            try {
                await signInAnonymously(auth); 
                userId = auth.currentUser?.uid || crypto.randomUUID();
                
                document.getElementById('user-id').textContent = userId;
                window.startSync(db, auth, userId); 
                
                resolve(true);
            } catch (error) {
                if (error.code === 'auth/configuration-not-found') {
                    console.error("해결책: Firebase 콘솔 -> Build -> Authentication -> Sign-in method 탭에서 'Anonymous'를 활성화해야 합니다.");
                }
                console.error("Firebase Auth or Init Error:", error);
                document.getElementById('sync-status').textContent = '인증 및 DB 연결 실패';
                document.getElementById('sync-status').classList.replace('text-yellow-500', 'text-red-500');
                resolve(false);
            }
        });
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .scroll-list::-webkit-scrollbar { width: 6px; }
        .scroll-list::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .scroll-list::-webkit-scrollbar-track { background: transparent; }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }

        /* 캘린더 스타일 */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            text-align: center;
        }
        .day-header {
            font-weight: bold;
            padding: 8px 0;
            font-size: 0.9rem;
        }
        .day-cell {
            padding: 4px;
            height: 80px; /* 고정 높이 */
            background-color: #fff;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.15s;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        .day-cell:hover:not(.empty-cell) {
            background-color: #e0f2fe; /* blue-100 */
        }
        .empty-cell {
            background-color: #f3f4f6;
            cursor: default;
        }
        .date-number {
            font-weight: bold;
            font-size: 0.8rem;
            width: 100%;
            text-align: left;
            padding: 2px 4px 0;
            color: #374151;
        }
        .total-amount {
            font-size: 0.75rem;
            color: #ef4444; /* red-500 */
            font-weight: 600;
            margin-top: 2px;
            line-height: 1.1;
        }
        .is-today {
            border: 2px solid #4f46e5; /* indigo-600 */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- 모달 백드롭 -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <!-- 모달 내용 -->
        <div id="calendar-modal" class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4">
            <div class="p-6">
                <h3 id="modal-date-title" class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2"></h3>
                <ul id="modal-detail-list" class="max-h-80 overflow-y-auto space-y-3 scroll-list">
                    <!-- 상세 내역이 여기에 삽입됩니다. -->
                </ul>
                <div id="modal-total-sum" class="text-right text-xl font-bold text-indigo-600 mt-4 pt-3 border-t"></div>
                <div class="mt-6 text-right">
                    <button id="modal-close-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition font-semibold">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <div id="status-bar" class="fixed top-0 left-0 right-0 p-2 bg-gray-800 text-white text-center text-sm shadow-lg z-50">
        <span id="sync-status" class="font-medium text-yellow-500">클라우드 데이터베이스 연결 중...</span> | 
        사용자 ID: <span id="user-id" class="font-mono text-xs"></span>
    </div>

    <div class="pt-10"> <!-- Fixed bar 때문에 본문 시작 위치 조정 -->
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-6 text-center">나의 똑똑한 가계부 (클라우드 동기화)</h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Section 1: 지출 입력 및 목록 (2/3 영역으로 확장됨) -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-full order-1 lg:order-1">
                <h2 class="text-2xl font-bold text-indigo-600 mb-4 border-b pb-2">1. 지출 등록</h2>
                <p class="text-sm text-gray-500 mb-4">지출을 기록하면 모든 기기에 자동 동기화됩니다.</p>

                <!-- 입력 폼 -->
                <form id="general-ledger-form" class="space-y-3 mb-8">
                    <input type="date" id="gl-date" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    
                    <!-- 카테고리 선택 필드 -->
                    <select id="gl-category" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        <option value="" disabled selected>-- 카테고리 선택 --</option>
                        <option value="식사">식사</option>
                        <option value="유흥">유흥</option>
                        <option value="쇼핑">쇼핑</option>
                        <option value="월정액">월정액</option>
                        <option value="기타">기타</option>
                    </select>

                    <input type="text" id="gl-item" placeholder="항목 (예: 저녁 식사, 넷플릭스)" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    <input type="number" id="gl-amount" placeholder="금액 (원)" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    <button type="submit" id="submit-btn" class="w-full bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition duration-150 font-semibold shadow-md" disabled>
                        지출 등록 및 동기화
                    </button>
                </form>

                <h2 class="text-2xl font-bold text-indigo-600 mb-4 border-b pb-2">카테고리 보고서</h2>
                <p class="text-sm text-gray-500 mb-4">선택된 월의 지출이 카테고리별로 자동 합산됩니다.</p>
                <div id="category-container-sidebar" class="grid grid-cols-1 gap-4">
                    <!-- Sidebar Category Cards will be dynamically inserted here -->
                </div>
            </div>


            <!-- Section 2: 달력 및 보고서 (2/3 영역으로 확장) -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg order-2 lg:order-2">
                <h2 class="text-2xl font-bold text-indigo-600 mb-4 border-b pb-2">2. 월별 지출 달력 및 합계</h2>
                <div class="flex justify-between items-center mb-4">
                    <div class="flex space-x-2">
                        <button id="prev-month-btn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-300 transition font-semibold">&lt;</button>
                        <h3 id="current-month-display" class="text-xl font-bold text-gray-800"></h3>
                        <button id="next-month-btn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-300 transition font-semibold">&gt;</button>
                    </div>
                    <div class="text-lg font-bold text-gray-700">총 합계: <span id="total-sum" class="text-xl font-extrabold text-indigo-700">0 원</span></div>
                </div>

                <!-- 캘린더 영역 -->
                <div id="calendar-area">
                    <!-- 요일 헤더 -->
                    <div class="calendar-grid mb-2">
                        <div class="day-header text-red-500">일</div>
                        <div class="day-header">월</div>
                        <div class="day-header">화</div>
                        <div class="day-header">수</div>
                        <div class="day-header">목</div>
                        <div class="day-header">금</div>
                        <div class="day-header text-blue-500">토</div>
                    </div>
                    <!-- 날짜 셀이 여기에 삽입됩니다. -->
                    <div id="calendar-days" class="calendar-grid"></div>
                </div>

                <!-- 월별 지출 목록 -->
                <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-3 border-t pt-3">선택 월 지출 기록</h3>
                <ul id="general-ledger-list" class="space-y-2 max-h-56 overflow-y-auto scroll-list">
                    <li class="text-center text-sm text-gray-400 py-4">클라우드에서 데이터 로딩 중...</li>
                </ul>
            </div>

        </div>
    </div>

    <!-- 렌더링 및 Firebase 동기화 로직 -->
    <script>
        // --- 전역 데이터 및 UI 요소 ---
        let allLedgerData = []; // Firebase에서 불러온 전체 데이터
        let currentCalendarDate = dayjs(); // 현재 캘린더가 보여주는 연월
        let dailyTotals = {}; // 일별 지출 합계를 저장하는 객체 { 'YYYY-MM-DD': amount }

        const categoryNames = ['식사', '유흥', '쇼핑', '월정액', '기타']; // '기타' 추가됨
        const categories = {}; 

        // UI 요소
        const glList = document.getElementById('general-ledger-list');
        const totalSumDisplay = document.getElementById('total-sum');
        const glForm = document.getElementById('general-ledger-form');
        const submitBtn = document.getElementById('submit-btn');
        const calendarDays = document.getElementById('calendar-days');
        const currentMonthDisplay = document.getElementById('current-month-display');
        const categoryContainerSidebar = document.getElementById('category-container-sidebar'); // 사이드바 보고서
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalDateTitle = document.getElementById('modal-date-title');
        const modalDetailList = document.getElementById('modal-detail-list');
        const modalTotalSum = document.getElementById('modal-total-sum');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        let db; 
        let ENTRIES_COLLECTION_PATH; 

        // --- 유틸리티 함수 ---

        function formatCurrency(amount) {
            if (isNaN(amount) || amount === null) return '0 원';
            return amount.toLocaleString('ko-KR') + ' 원';
        }

        // --- Firebase 동기화 로직 ---

        window.startSync = (firestoreDbInstance, auth, currentUserId) => {
            const { collection, onSnapshot, query, ENTRIES_COLLECTION_PATH: path } = window.moduleExports;
            
            db = firestoreDbInstance;
            ENTRIES_COLLECTION_PATH = path; 
            
            const entriesCollectionRef = collection(db, ENTRIES_COLLECTION_PATH);
            
            // 실시간 리스너 설정
            onSnapshot(query(entriesCollectionRef), (snapshot) => {
                allLedgerData = [];
                snapshot.forEach(doc => {
                    allLedgerData.push({ id: doc.id, ...doc.data() });
                });
                console.log('Data synced from Firestore. Total entries:', allLedgerData.length);
                
                // 데이터 로드 후 캘린더 초기화 및 렌더링 시작
                renderCalendar(); 
                
                document.getElementById('sync-status').textContent = '클라우드 동기화 완료';
                document.getElementById('sync-status').classList.replace('text-yellow-500', 'text-green-500');
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                document.getElementById('sync-status').textContent = '동기화 오류 발생. 콘솔 확인.';
                document.getElementById('sync-status').classList.replace('text-green-500', 'text-red-500');
            });

            // 데이터베이스 준비 완료 후 입력 활성화
            submitBtn.disabled = false;
            submitBtn.textContent = '지출 등록 및 동기화';
        };

        // --- 캘린더 및 필터링 로직 ---

        function calculateDailyTotals(targetMonth) {
            dailyTotals = {};
            const targetMonthStr = targetMonth.format('YYYY-MM');
            
            allLedgerData.forEach(entry => {
                if (entry.date.startsWith(targetMonthStr)) {
                    const dateKey = entry.date; // YYYY-MM-DD
                    const amount = Number(entry.amount) || 0;
                    dailyTotals[dateKey] = (dailyTotals[dateKey] || 0) + amount;
                }
            });
            
            // 캘린더에 표시할 월의 총 합계 계산
            const monthlyTotal = Object.values(dailyTotals).reduce((sum, amount) => sum + amount, 0);
            totalSumDisplay.textContent = formatCurrency(monthlyTotal);
            
            // 카테고리 보고서를 위해 현재 월 데이터 필터링 후 재계산
            const currentMonthData = allLedgerData.filter(entry => entry.date.startsWith(targetMonthStr));
            recalculateCategoryReport(currentMonthData);
        }
        
        function renderCalendar() {
            currentMonthDisplay.textContent = currentCalendarDate.format('YYYY년 M월');
            calculateDailyTotals(currentCalendarDate);

            calendarDays.innerHTML = '';

            const today = dayjs().format('YYYY-MM-DD');
            const startOfMonth = currentCalendarDate.startOf('month');
            const endOfMonth = currentCalendarDate.endOf('month');
            const firstDayOfWeek = startOfMonth.day(); // 0: 일요일, 6: 토요일

            // 빈 셀 (지난 달) 채우기
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell empty-cell';
                calendarDays.appendChild(emptyCell);
            }

            // 날짜 채우기
            for (let date = startOfMonth; date.isSame(endOfMonth) || date.isBefore(endOfMonth); date = date.add(1, 'day')) {
                const dateKey = date.format('YYYY-MM-DD');
                const day = date.date();
                const totalAmount = dailyTotals[dateKey] || 0;
                
                const cell = document.createElement('div');
                cell.className = `day-cell relative group ${dateKey === today ? 'is-today' : ''}`;
                cell.dataset.date = dateKey;
                
                cell.innerHTML = `
                    <div class="date-number">${day}</div>
                    ${totalAmount > 0 
                        ? `<div class="total-amount">${formatCurrency(totalAmount)}</div>` 
                        : ''}
                `;
                
                // 날짜 클릭 이벤트 리스너 추가
                if (totalAmount > 0) {
                    cell.addEventListener('click', () => showDayDetailModal(dateKey));
                }
                
                calendarDays.appendChild(cell);
            }
        }
        
        // --- 카테고리 보고서 로직 (Sidebar) ---
        
        function recalculateCategoryReport(data) {
            categoryNames.forEach(name => {
                categories[name] = [];
            });

            data.forEach(entry => {
                if (categories[entry.category]) {
                    categories[entry.category].push(entry); // 전체 엔트리를 복사
                }
            });

            renderAllCategoriesSidebar();
        }

        function calculateCategoryTotal(categoryName) {
            return categories[categoryName].reduce((sum, entry) => sum + (Number(entry.amount) || 0), 0);
        }

        function renderAllCategoriesSidebar() {
            categoryContainerSidebar.innerHTML = '';
            categoryNames.forEach(name => {
                const data = categories[name];
                const total = calculateCategoryTotal(name);

                const colorConfig = {
                    '식사': { bg: 'bg-green-100', text: 'text-green-700', border: 'border-green-400' },
                    '유흥': { bg: 'bg-red-100', text: 'text-red-700', border: 'border-red-400' },
                    '쇼핑': { bg: 'bg-blue-100', text: 'text-blue-700', border: 'border-blue-400' },
                    '월정액': { bg: 'bg-purple-100', text: 'text-purple-700', border: 'border-purple-400' },
                    '기타': { bg: 'bg-yellow-100', text: 'text-yellow-700', border: 'border-yellow-400' }
                };
                const { bg, text, border } = colorConfig[name] || colorConfig['기타'];

                const card = document.createElement('div');
                card.className = `p-3 border-l-4 rounded-lg shadow-sm ${bg} ${text} ${border}`;
                card.innerHTML = `
                    <h3 class="font-bold text-base mb-1">${name} <span class="text-xs font-normal">(${data.length}건)</span></h3>
                    <div class="text-lg font-extrabold">${formatCurrency(total)}</div>
                `;
                categoryContainerSidebar.appendChild(card);
            });
        }
        
        // --- 모달 로직 ---
        
        function showDayDetailModal(dateKey) {
            const dateStr = dayjs(dateKey).format('YYYY년 M월 D일 (ddd)');
            modalDateTitle.textContent = `${dateStr} 지출 상세 내역`;
            modalDetailList.innerHTML = '';
            
            // 해당 날짜의 데이터만 필터링
            const dayData = allLedgerData.filter(entry => entry.date === dateKey).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (dayData.length === 0) {
                 modalDetailList.innerHTML = '<li class="text-center text-gray-500 py-4">해당 날짜에 기록된 지출이 없습니다.</li>';
                 modalTotalSum.textContent = `합계: 0 원`;
            } else {
                let total = 0;
                dayData.forEach(entry => {
                    total += Number(entry.amount) || 0;
                    
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200';
                    li.innerHTML = `
                        <div class="flex-grow">
                            <div class="text-xs font-medium text-indigo-500">${entry.category}</div>
                            <div class="font-semibold text-gray-800">${entry.item}</div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="font-bold text-red-500">${formatCurrency(entry.amount)}</span>
                            <button class="delete-btn-modal text-red-400 hover:text-red-600 transition" data-id="${entry.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    modalDetailList.appendChild(li);
                });
                modalTotalSum.textContent = `합계: ${formatCurrency(total)}`;
                
                // 모달 내 삭제 버튼 이벤트 리스너 추가
                document.querySelectorAll('.delete-btn-modal').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const docId = e.currentTarget.dataset.id;
                        const { doc, deleteDoc } = window.moduleExports;

                        try {
                            // Firestore에서 문서 삭제 (자동으로 캘린더와 모달이 갱신됨)
                            await deleteDoc(doc(db, ENTRIES_COLLECTION_PATH, docId)); 
                            // 삭제 후 모달 닫기
                            modalBackdrop.classList.add('hidden');
                        } catch (error) {
                            console.error("Error removing document: ", error);
                        }
                    });
                });
            }
            
            modalBackdrop.classList.remove('hidden');
            modalBackdrop.style.display = 'flex'; // Tailwind hidden 클래스 제거
        }

        function closeModal() {
            modalBackdrop.classList.add('hidden');
        }

        // --- 이벤트 리스너 ---

        // 이전/다음 월 버튼 이벤트
        document.getElementById('prev-month-btn').addEventListener('click', () => {
            currentCalendarDate = currentCalendarDate.subtract(1, 'month');
            renderCalendar();
        });

        document.getElementById('next-month-btn').addEventListener('click', () => {
            currentCalendarDate = currentCalendarDate.add(1, 'month');
            renderCalendar();
        });

        // 모달 닫기 이벤트
        modalCloseBtn.addEventListener('click', closeModal);
        modalBackdrop.addEventListener('click', (e) => {
            if (e.target === modalBackdrop) {
                closeModal();
            }
        });


        // 폼 제출 시 Firebase에 저장
        glForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (submitBtn.disabled) return; 

            const date = document.getElementById('gl-date').value;
            const category = document.getElementById('gl-category').value;
            const item = document.getElementById('gl-item').value.trim();
            const amount = Number(document.getElementById('gl-amount').value);
            
            if (!date || !category || item === '' || isNaN(amount) || amount <= 0) {
                console.error('날짜, 항목, 카테고리, 금액을 모두 올바르게 입력해야 합니다.');
                return;
            }

            const newEntry = {
                date: date,
                category: category,
                item: item,
                amount: amount,
                timestamp: new Date().toISOString(), 
            };

            const { addDoc, collection } = window.moduleExports;
            try {
                const docRef = await addDoc(collection(db, ENTRIES_COLLECTION_PATH), newEntry);
                console.log("Document written with ID: ", docRef.id);
                
                // 폼 초기화 및 캘린더를 오늘 날짜로 재설정 (자동 갱신 유도)
                glForm.reset(); 
                document.getElementById('gl-date').value = dayjs().format('YYYY-MM-DD');
                currentCalendarDate = dayjs();
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        });

        // 초기 날짜 설정
        window.onload = () => {
             document.getElementById('gl-date').value = dayjs().format('YYYY-MM-DD');
             // 나머지 초기화는 startSync에서 데이터 로드 후 진행됩니다.
        };

    </script>
</body>
</html>
